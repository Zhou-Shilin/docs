---
title: "セッション管理"
description: "高度なセッション運用、履歴確認、ストレージ構成、復旧プレイブック。"
---

## セッション運用が重要な理由

セッションは MineClawd の長期記憶です。整理されたセッション運用を行うと、応答品質が上がり、文脈ミスが減り、障害時の復旧も速くなります。

## セッションのスコープ

- セッションは owner key ごとに分離されます。
- プレイヤーコマンドはプレイヤー UUID を owner key として使います。
- コンソールコマンドはコマンドソース名を owner key として使います。
- 各 owner は 1 つのアクティブセッションポインタを持ちます。
- すべてのセッションコマンドに OP 権限レベル `2` が必要です。

## 日常のコマンド運用フロー

| 目的 | コマンド |
| --- | --- |
| 新しい文脈で開始 | `/mineclawd sessions new` |
| 保存済みセッションを確認 | `/mineclawd sessions list` |
| アクティブ文脈を切り替え | `/mineclawd sessions resume <session>` |
| 古い文脈を削除 | `/mineclawd sessions remove <session>` |
| 現在のチャット履歴を読む | `/mineclawd history` |
| 破損した Vertex ターンを修復 | `/mineclawd sessions repair [session]` |

`<session>` には `1a2b` のような短い ID か、`1a2b-my-build-plan` のような token を指定できます。

<Tip>
メモ、スクリプト、ランブックでは短いセッション ID を優先してください。ID は安定しています。token のタイトル部分は MineClawd がより良いタイトルを生成した後に変わることがあります。
</Tip>

## 長い作業のベストプラクティス

1. 何でも 1 セッションに入れず、目的ごとに 1 セッションを使います。
2. 古い履歴を引きずり続けるより、新しいセッションを作って文脈を更新します。
3. `resume`、`remove`、`repair` の前に `/mineclawd sessions list` を実行します。
4. リクエスト実行中のセッション変更を避けます。
5. 破壊的作業の前に `/mineclawd history` で文脈を確認します。

## `/mineclawd history` をうまく使う

- 履歴本にはセッショントークン、更新時刻、表示可能なチャットターンが含まれます。
- このコマンドはコンソールではなくプレイヤーでのみ動作します。
- 履歴本 UI にはクライアント側 MineClawd が必要です。
- 非常に長い履歴は Minecraft 本ページ上限に合わせて切り詰められます。

クライアントに MineClawd が入っていない場合は、`sessions list` と直近チャットログを代替の文脈確認手段にしてください。

## 復旧プレイブック

### リクエスト失敗したが文脈は維持したい

最新の失敗メッセージにある token を使って `/mineclawd retry <token>` を実行します。retry token は 30 分で期限切れです。

### Vertex function-call 不一致エラー

次を実行します:

```bash
/mineclawd sessions repair
```

または特定セッションを対象にします:

```bash
/mineclawd sessions repair <session>
```

`repair` は破損した Vertex function-call ターンを正規化し、修復済みセッションを保存します。

## セッションファイルの場所

MineClawd はゲームディレクトリ配下にセッションを保存します:

```text
mineclawd/
  sessions/
    <owner>/
      active.json
      <id>.json
```

- `active.json` はアクティブセッション ID を保存します。
- `<id>.json` はメタデータと両プロバイダー履歴（`openAiHistory`, `vertexHistory`）を保存します。
- アクティブセッションを削除すると、MineClawd は最終更新が最も新しい残存セッションを自動選択します。残存がなければアクティブセッションは解除されます。

## バックアップとクリーンアップ戦略

1. 一括クリーンアップ前に `mineclawd/sessions/` をバックアップします。
2. `/mineclawd sessions remove <session>` で古いセッションを削除します。
3. オペレーターごとに既知の正常セッションを 1 つ残し、迅速なロールバックに備えます。
4. ストレージ内部を確認したい場合は `/resources/technical-details` を参照します。

## 関連ページ

- [/commands/sessions-list](/commands/sessions-list)
- [/commands/sessions-resume](/commands/sessions-resume)
- [/commands/sessions-repair](/commands/sessions-repair)
- [/commands/history](/commands/history)
