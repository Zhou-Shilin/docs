---
title: "技术细节"
description: "MineClawd 的架构、存储、限制与运行时内部机制。"
---

## 请求生命周期

1. 你运行 `/mclawd ...` 或 `/mineclawd prompt ...`。
2. MineClawd 校验 provider 配置和 OP 权限。
3. MineClawd 加载或创建活动会话状态。
4. MineClawd 向 OpenAI 兼容或 Vertex endpoint 发送请求。
5. 模型响应可能触发工具调用。
6. 工具结果会回送进模型循环。
7. 最终 assistant 输出会渲染到聊天中，并保存会话历史。

## 运行时工具分类

- 命令与脚本执行：
  - `execute-command`
  - `apply-instant-server-script`
- 持久化脚本文件：
  - `list-server-scripts`
  - `read-server-script`
  - `write-server-script`
  - `delete-server-script`
  - `reload-game`
  - `sync-command-tree`
- 澄清交互：
  - `ask-user-question`
- 动态占位符（仅在启用时）：
  - `list-dynamic-content`
  - `register-dynamic-item`
  - `register-dynamic-block`
  - `register-dynamic-fluid`
  - `update-dynamic-item`
  - `update-dynamic-block`
  - `update-dynamic-fluid`
  - `unregister-dynamic-content`

## 存储布局

```text
gameDir/
  config/
    mineclawd.json5
  mineclawd/
    player-settings.json
    sessions/
      <owner>/
        active.json
        <id>.json
    souls/
      default.md
      yuki.md
      <custom>.md
      .active/
        <owner>.txt
  kubejs/
    server_scripts/
      mineclawd/
        ...
```

## 会话内部机制

- session id 是 4 位小写 token。
- 命令 token 格式为 `<id>-<title-slug>`。
- 会话文件分别存储 OpenAI 和 Vertex 历史。
- 活动会话指针按 owner 存储在 `active.json` 中。
- 会话标题在第一次成功轮次后由 summarize model 生成。

## LLM 传输细节

- OpenAI 兼容请求路径：`<endpoint>/chat/completions`
- Vertex 请求路径：`<endpoint>/<model>:generateContent?key=<api_key>`
- 两种路径都使用 60 秒请求超时。
- 两种路径都支持 function 风格工具调用。

## Dynamic placeholder 内部机制

- 容量：`30` 个 item 槽位、`30` 个 block 槽位、`30` 个 fluid 槽位。
- 固定 id 包括：
  - `mineclawd:dynamic_item_001`
  - `mineclawd:dynamic_block_001`
  - `mineclawd:dynamic_fluid_001`
- 状态同步使用 `sync_dynamic_content` 网络负载。
- 状态持久化使用世界 `PersistentState` id `mineclawd_dynamic_content`。
- `AUTO` 模式会在客户端运行时启用运行时占位符，并在专用服务器禁用。

## 网络通道

MineClawd 定义了这些数据包标识符：

- `mineclawd:open_config`
- `mineclawd:sync_broadcast_target`
- `mineclawd:sync_dynamic_content`
- `mineclawd:open_question`
- `mineclawd:question_response`
- `mineclawd:open_history_book`

## 限制与计时器

| 设置或行为 | 值 |
| --- | --- |
| 工具调用上限范围 | `1` 到 `20` |
| 工具调用上限默认值 | `16` |
| 工具调用上限默认状态 | disabled |
| Ask-user 最大选项数 | `5` |
| Ask-user 超时时间 | `60` 秒 |
| 失败请求 retry token TTL | `30` 分钟 |
| 限流重试次数 | `2` 次重试 |
| 限流重试退避 | `1500ms * retry_index` |
| 书本历史构建最大条目数 | `300` |

## 安全模型

- 每条命令路径都受 OP 权限门控。
- KubeJS 执行是真实服务器执行，不是模拟。
- API keys 必须按密钥处理。
- 只在可信环境中使用。
