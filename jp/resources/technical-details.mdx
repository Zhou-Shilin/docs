---
title: "技術詳細"
description: "MineClawd のアーキテクチャ、ストレージ、制限値、実行時内部仕様。"
---

## リクエストライフサイクル

1. `/mclawd ...` または `/mineclawd prompt ...` を実行します。
2. MineClawd がプロバイダー設定と OP 権限を検証します。
3. MineClawd がアクティブセッション状態を読み込むか新規作成します。
4. MineClawd が OpenAI 互換または Vertex エンドポイントへリクエストを送信します。
5. モデル応答によってツール呼び出しが発生することがあります。
6. ツール結果はモデルループへ戻されます。
7. 最終アシスタント出力がチャットに表示され、セッション履歴が保存されます。

## 実行時ツールファミリー

- コマンドとスクリプト実行:
  - `execute-command`
  - `apply-instant-server-script`
- 永続スクリプトファイル:
  - `list-server-scripts`
  - `read-server-script`
  - `write-server-script`
  - `delete-server-script`
  - `reload-game`
  - `sync-command-tree`
- 確認質問:
  - `ask-user-question`
- 動的プレースホルダー（有効時のみ）:
  - `list-dynamic-content`
  - `register-dynamic-item`
  - `register-dynamic-block`
  - `register-dynamic-fluid`
  - `update-dynamic-item`
  - `update-dynamic-block`
  - `update-dynamic-fluid`
  - `unregister-dynamic-content`

## ストレージ構成

```text
gameDir/
  config/
    mineclawd.json5
  mineclawd/
    player-settings.json
    sessions/
      <owner>/
        active.json
        <id>.json
    souls/
      default.md
      yuki.md
      <custom>.md
      .active/
        <owner>.txt
  kubejs/
    server_scripts/
      mineclawd/
        ...
```

## セッション内部仕様

- セッション ID は 4 文字の小文字トークンです。
- コマンド token 形式は `<id>-<title-slug>` です。
- セッションファイルは OpenAI と Vertex の履歴を別々に保存します。
- アクティブセッションポインタは owner ごとの `active.json` に保存されます。
- セッションタイトルは最初の正常ラウンド後に要約モデルで生成されます。

## LLM 転送詳細

- OpenAI 互換リクエストパス: `<endpoint>/chat/completions`
- Vertex リクエストパス: `<endpoint>/<model>:generateContent?key=<api_key>`
- 両パスともリクエストタイムアウトは 60 秒です。
- 両パスとも function 形式のツール呼び出しをサポートします。

## 動的プレースホルダー内部仕様

- 容量: item スロット `30`、block スロット `30`、fluid スロット `30`。
- 固定 id の例:
  - `mineclawd:dynamic_item_001`
  - `mineclawd:dynamic_block_001`
  - `mineclawd:dynamic_fluid_001`
- 状態同期は `sync_dynamic_content` ネットワークペイロードを使います。
- 状態永続化はワールド `PersistentState` id `mineclawd_dynamic_content` を使います。
- `AUTO` モードはクライアント実行環境で実行時プレースホルダーを有効化し、専用サーバーでは無効化します。

## ネットワークチャンネル

MineClawd は次のパケット識別子を定義します:

- `mineclawd:open_config`
- `mineclawd:sync_broadcast_target`
- `mineclawd:sync_dynamic_content`
- `mineclawd:open_question`
- `mineclawd:question_response`
- `mineclawd:open_history_book`

## 制限値とタイマー

| 設定または動作 | 値 |
| --- | --- |
| `tool-call-limit` の範囲 | `1` から `20` |
| `tool-call-limit` のデフォルト値 | `16` |
| `tool-call-limit` のデフォルト状態 | 無効 |
| `ask-user-question` の最大選択肢数 | `5` |
| `ask-user-question` のタイムアウト | `60` 秒 |
| 失敗リクエスト retry token TTL | `30` 分 |
| レート制限時のリトライ回数 | `2` 回 |
| レート制限時のバックオフ | `1500ms * retry_index` |
| 本 UI 生成時の履歴最大件数 | `300` |

## セキュリティモデル

- すべてのコマンド経路は OP で保護されます。
- KubeJS 実行はシミュレーションではなく実サーバー実行です。
- API キーは秘密情報として扱う必要があります。
- 信頼できる環境でのみ使用してください。
