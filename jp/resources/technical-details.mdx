---
title: "技術詳細"
description: "MineClawd のアーキテクチャ、ストレージ、制限、ランタイムの挙動。"
---

## リクエストライフサイクル

1. `/mclawd ...`、`/mineclawd prompt ...`、またはオーバーレイ入力バーでリクエストを送信します。
2. MineClawd がプロバイダー設定と OP 権限を検証します。
3. アクティブなセッション状態を読み込み、存在しなければ作成します。
4. OpenAI 互換または Vertex エンドポイントにストリーミングリクエストを送信します。
5. `AGENT_STREAM_EVENT` チャネルを通じてクライアントにデルタをリアルタイムで送ります。オーバーレイは点滅カーソル付きで文字を描画します。
6. モデルの応答がツール呼び出しをトリガーすると、ツール結果を再度モデルへフィードバックします。
7. 最終的なアシスタント出力をチャット（オーバーレイ含む）に表示し、セッション履歴を保存します。

## ランタイムツールのカテゴリ

- コマンドとスクリプト実行:
  - `execute-command`
  - `apply-instant-server-script`
- 永続スクリプトファイル:
  - `list-server-scripts`
  - `read-server-script`
  - `write-server-script`
  - `delete-server-script`
  - `reload-game`
  - `sync-command-tree`
- 説明要求:
  - `ask-user-question`
- アセット追跡:
  - `list-assets`
  - `upsert-asset-record`
  - `remove-asset-record`
- 動的プレースホルダー（有効時のみ）:
  - `list-dynamic-content`
  - `register-dynamic-item`
  - `register-dynamic-block`
  - `register-dynamic-fluid`
  - `update-dynamic-item`
  - `update-dynamic-block`
  - `update-dynamic-fluid`
  - `unregister-dynamic-content`

## ストレージ構成

```text
gameDir/
  config/
    mineclawd.json5
  mineclawd/
    player-settings.json
    sessions/
      <owner>/
        active.json
        <id>.json
    assets/
      <owner>.json
    souls/
      default.md
      yuki.md
      <custom>.md
      .active/
        <owner>.txt
  kubejs/
    server_scripts/
      mineclawd/
        ...
```

## セッション内部

- セッション ID は小文字 4 文字です。
- コマンドトークンは `<id>-<title-slug>` 形式です。
- セッションファイルには OpenAI 履歴と Vertex 履歴が別々に保存されます。
- `active.json` にオーナー単位でアクティブセッションポインタを保持します。
- 最初の成功したターン後にサマリーモデルでセッションタイトルを生成します。

## LLM の通信先

- OpenAI 互換: `<endpoint>/chat/completions`
- Vertex: `<endpoint>/<model>:generateContent?key=<api_key>`
- 双方とも 60 秒のタイムアウトを使います。
- 両方ともツール呼び出しとストリーミングをサポートします。ストリームデルタは `AGENT_STREAM_EVENT` へ送られます。

## ストリーミングアーキテクチャ

ストリームイベントはリクエスト ID、イベントタイプバイト、ペイロード文字列で構成されます。

| イベントタイプ | バイト | ペイロード |
| --- | --- | --- |
| `START` | `0` | `sessionId` と `request` テキストを含む JSON |
| `DELTA` | `1` | LLM からのテキスト断片 |
| `DONE` | `2` | 空 |
| `ERROR` | `3` | エラーメッセージ文字列 |

オーバーレイはこれらを受け取り、`DONE` または `ERROR` まで点滅カーソルとともにレンダリングします。

アクティブリクエストはサーバー側で `ACTIVE_REQUESTS` と `ACTIVE_NETWORK_REQUESTS` で追跡されます。`/mineclawd stop` はリクエスト ID を `CANCELLED_REQUEST_IDS` にマークし、HTTP 接続をキャンセルします。

## 動的プレースホルダーの内部

- アイテム/ブロック/流体スロットそれぞれ 30 枠。
- 固定 ID:
  - `mineclawd:dynamic_item_001`
  - `mineclawd:dynamic_block_001`
  - `mineclawd:dynamic_fluid_001`
- 状態同期は `sync_dynamic_content` ペイロードを使います。
- 永続化はワールドの `PersistentState` ID `mineclawd_dynamic_content` を使います。
- `AUTO` モードはクライアントランタイムで有効化し、専用サーバーでは無効化します。

## ネットワーキングチャネル

MineClawd は次のパケット識別子を定義します:

- `mineclawd:client_ready`
- `mineclawd:client_gui_pref`
- `mineclawd:open_config`
- `mineclawd:sync_broadcast_target`
- `mineclawd:sync_assistive_touch`
- `mineclawd:sync_dynamic_content`
- `mineclawd:open_question`
- `mineclawd:question_response`
- `mineclawd:open_sessions`
- `mineclawd:open_assets`
- `mineclawd:open_history_book`
- `mineclawd:agent_stream_event`

## アセット追跡の内部

アセット記録はオーナー単位で `mineclawd/assets/<owner>.json` に保存され、各記録に以下を含みます:

- `id`
- `category`: `ENTITIES`, `ITEMS_BLOCKS_FLUIDS`, `SPECIAL_ITEMS`, `COMMANDS`, `GAME_MECHANICS`
- `name`, `summary`, `scriptPath`, `details`
- カテゴリ固有フィールド: `contentId`, `specialItemId`, `specialItemNbt`, `command`, `entityUuid`, `entityDimension`, `entityX`, `entityY`, `entityZ`
- `sessionId`
- `createdAt`, `updatedAt`

システムプロンプトにアセット追跡用の付録が入っているため、LLM は `upsert-asset-record` を呼んで自動で記録します。

## 制限とタイマー

| 設定または挙動 | 値 |
| --- | --- |
| ツール呼び出し制限範囲 | `1` 〜 `20` |
| ツール呼び出し制限のデフォルト | `16` |
| ツール呼び出し制限の既定状態 | 無効 |
| ask-user の最大選択肢 | `5` |
| ask-user タイムアウト | `60` 秒 |
| 失敗リクエストの再試行トークン TTL | `30` 分 |
| レートリミット再試行回数 | `2` |
| レートリミット再試行バックオフ | `1500ms × retry_index` |
| 履歴書籍の最大エントリ数 | `300` |
| オーバーレイ入力バーの最大長 | `600` 文字 |
| アセットカテゴリ数 | `5` |

## セキュリティモデル

- すべてのコマンドパスは OP が必要です。
- KubeJS の実行は実際のサーバー実行であり、エミュレーションではありません。
- API キーは機密として扱います。
- 信頼できる環境でのみ MineClawd を使ってください。
